<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: modules/listing.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: modules/listing.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>
'use strict'

const sqlite = require('sqlite-async')

/** 
 * Class that handles listing operations.
 * */
class Listing {

	/**
     * Initialises database and adds 'item' and 'trade' tables if it does not already exist
     * @constructor
     * @param {String} [dbName] - The name of the database. Defaults to :memory:
     * @returns {Listing} New instance of Listing class
     */
	constructor(dbName = ':memory:') {
		return (async() => {
			this.db = await sqlite.open(dbName)
			// we need this table to store the user accounts
			const sql = 'CREATE TABLE IF NOT EXISTS item (item_id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL, user_id INTEGER REFERENCES user (user_id) NOT NULL, item_name VARCHAR (50) NOT NULL, item_description VARCHAR (250) NOT NULL, item_img_loc VARCHAR (50) NOT NULL); CREATE TABLE IF NOT EXISTS trade (swap_id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL, buying_id INTEGER REFERENCES item (item_id) NOT NULL, selling_id INTEGER REFERENCES item (item_id) NOT NULL)'
			await this.db.run(sql)
			return this
		})()
	}

	/** Object definition inspired by answer from Dan Dascalescu at https://stackoverflow.com/a/28763616
	 * Metadata object used to render information in listing.handlebars
	 * @typedef {Object} ListingMetadata
	 * @property {Integer} id The listing ID
	 * @property {String} itemname The item name
	 * @property {String} itemdescription The item description
	 * @property {String} swaplist Comma separated list of items to swap
	 * @property {String} listerusername Username of listing's creator
	 * @property {String} imgloc Location of Listing's image
	 */

	/**
     * Gets the metadata object literal for a given listing
     * @param {Integer} listing_id - The ID of the listing/item
     * @returns {ListingMetadata} ListingMetadata object literal
     * @throws Will throw an error if operation fails and provide descriptive reasoning
     */
	async getMetadata(listing_id) {
		try {
			let listing_exists_sql = `SELECT COUNT(item_id) as records FROM item WHERE item_id="${listing_id}";`
			const data = await this.db.get(listing_exists_sql)
			if(data.records == 0) throw new Error(`listing with ID "${listing_id}" not found`)
			let sql = `SELECT item_id, user_id, item_name, item_description, item_img_loc FROM item WHERE item_id="${listing_id}";`
			const record = await this.db.get(sql)
			
			let lister = record.user_id

			let item = {
				id: record.item_id,
				itemname: record.item_name,
				itemdescription: record.item_description,
				imgloc: record.item_img_loc
			}

			let username_grab_sql = `SELECT username FROM user WHERE user_id="${lister}";`
			const username_record = await this.db.get(username_grab_sql)

			item.listerusername = username_record.username

			item.swaplist = "Placeholder, Placeholder Second, Placeholder Third" //Placeholder until I figure out schema

			return item
		} catch(err) {
			throw err
		}
	}

	/**
     * Gets the metadata object literal for all listings in an array
     * @returns {Array} Array of ListingMetadata object literals
     * @throws Will throw an error if operation fails and provide descriptive reasoning
     */
	async getListings() {
		try {
			let listing_exists_sql = `SELECT COUNT(item_id) as records FROM item;`
			const data = await this.db.get(listing_exists_sql)
			if(data.records == 0) throw new Error(`no listings found`)
			let sql = `SELECT item_id, item_name, item_description, item_img_loc FROM item;`
			let results = []

			const rows = await this.db.all(sql)

			for(let i = 0; i &lt; rows.length; i++){

				let item = {
					id: rows[i].item_id,
					itemname: rows[i].item_name,
					itemdescription: rows[i].item_description,
					imgloc: rows[i].item_img_loc,
					listerusername: "", //not viewable for logged out users
					swaplist: "" //not viewable for logged out users
				}

				results.push(item)
			}

			return results

		} catch(err) {
			throw err
		}
	}

	/**
     * Creates a listing and returns the listing ID. Does not check if the data is valid
     * @param {Integer} user_id - The ID of the listing/item
     * @param {String} item_name - Name of the item being listed
     * @param {String} item_description - Description of the item listing
     * @param {String} img_location - Relative filepath from webroot to the item image
     * @returns {Integer} ID of new listing
     */
	async create(user_id, item_name, item_description,  img_location) {
		try {

			if(isNaN(user_id)){
				throw new Error('non-numeric user_id provided')
			}else if(user_id.toString().length == 0){
				throw new Error('no user_id provided')
			}else if(item_name.length == 0){
				throw new Error('no item_name provided')
			}else if(item_description.length == 0){
				throw new Error('no item_description provided')
			}else if(img_location.length == 0){
				throw new Error('no img_location provided')
			}

			let sql = `INSERT INTO item (user_id, item_name, item_description, item_img_loc) VALUES (${user_id}, '${item_name}', '${item_description}', '${img_location}');`
			let query = await this.db.run(sql)
			return query.lastID
		} catch(err) {
			throw err
		}
	}

}

module.exports = Listing</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Listing.html">Listing</a></li><li><a href="User.html">User</a></li></ul><h3>Global</h3><ul><li><a href="global.html">About Page</a></li><li><a href="global.html">Account Page</a></li><li><a href="global.html">Home Page</a></li><li><a href="global.html">Listing Page</a></li><li><a href="global.html">Login Page</a></li><li><a href="global.html">Login Script</a></li><li><a href="global.html">Logout Page</a></li><li><a href="global.html">Offer creation Page</a></li><li><a href="global.html">Register Page</a></li><li><a href="global.html">Register Script</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Wed Nov 27 2019 23:55:25 GMT+0000 (Greenwich Mean Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
