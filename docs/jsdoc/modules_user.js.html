<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: modules/user.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: modules/user.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict'

const bcrypt = require('bcrypt-promise')
const fs = require('fs-extra')
const mime = require('mime-types')
const sqlite = require('sqlite-async')
const saltRounds = 10

/** 
 * Class that handles user operations.
 * */
class User {

    /**
     * Initialises database and adds 'users' table if it does not already exist
     * @constructor
     * @param {String} [dbName] - The name of the database. Defaults to :memory:
     * @returns {User} New instance of User class
     */
	constructor(dbName = ':memory:') {
		return (async() => {
			this.db = await sqlite.open(dbName)
			// we need this table to store the user accounts
			const sql = 'CREATE TABLE IF NOT EXISTS user (user_id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL, username VARCHAR (32) NOT NULL, password VARCHAR (60) NOT NULL, forename VARCHAR (32) NOT NULL, surname VARCHAR (32) NOT NULL, email VARCHAR (50) NOT NULL);'
			await this.db.run(sql)
			return this
		})()
	}

    /**
     * Register an user. This checks for existing entries for a given username
     * @param {String} username - The username of the new user.
     * @param {String} password - The password of the new user.
     * @param {String} forename - The forename of the new user.
     * @param {String} surname - The surname of the new user.
     * @param {String} email - The email of the new user.
     * @returns {Boolean} True on success, throws an error error on failure
     * @throws Will throw an error if operation fails and provide descriptive reasoning
     */
    async register(user, pass, forename, surname, email) {
        try {

            var patt1 = /[ ]/g; // exclude &lt;these> characters from username and password
            if (user === '' || user.match(patt1) != null) throw new Error('Username can\'t be empty') //async ctx => ctx.redirect('/register?msg=invalid%20username.%20Enter%20correct%20Username') // new Error('Incorrect username') //return ctx.redirect('/register?msg=invalid%20username.%20Enter%20correct%20Username')
            if (pass === '' || pass.match(patt1) != null) throw new Error('Password can\'t be empty') //return ctx.redirect('/register?msg=invalid%20username.%20Password%20has%20to%20contain%20characters')
            if (forename.length === 0) throw new Error('missing forename')
            if (surname.length === 0) throw new Error('missing surname')
            if (email.length === 0) throw new Error('missing email')
            let sqlUser = `SELECT COUNT(user_id) as records FROM user WHERE username="${user}";`
            const dataUser = await this.db.get(sqlUser)
            if (dataUser.records !== 0) throw new Error(`username "${user}" already in use`)
            let sqlEmail = `SELECT COUNT(user_id) as records FROM user WHERE email="${email}";`
            const dataEmail = await this.db.get(sqlEmail)
            if (dataEmail.records !== 0) throw new Error(`email "${email}" already in use`)
            pass = await bcrypt.hash(pass, saltRounds)
            let sql = `INSERT INTO user(username, password, forename, surname, email) VALUES("${user}", "${pass}", "${forename}", "${surname}", "${email}")`
            await this.db.run(sql)
            return true
        } catch (err) {
            throw err
        }
    }

    /**
     * Login an user.
     * @param {String} email - The email of the user.
     * @param {String} password - The password of the user.
     * @returns {Boolean} True on success, throws an error error on failure
     * @throws Will throw an error if operation fails and provide descriptive reasoning
     */
    async login(email, password) {
        try {
            let sql = `SELECT count(user_id) AS count FROM user WHERE email="${email}";`
            const records = await this.db.get(sql)
            if (!records.count) throw new Error(`email "${email}" not found`)
            sql = `SELECT password FROM user WHERE email= "${email}";`
            const record = await this.db.get(sql)
            const valid = await bcrypt.compare(password, record.password)
            if (valid === false) throw new Error(`invalid password for account "${email}"`)
            return true
        } catch (err) {
            throw err
        }
    }

    /**
     * Get all database information for an user.
     * @param {String} email - The email of the user.
     * @returns {Array} Array of user data for the given email
     * @throws Will throw an error if operation fails and provide descriptive reasoning
     */
    async getUserData(email) {
        try {
            let sql = `SELECT * FROM user WHERE email= "${email}";`
            const record = await this.db.get(sql)
            return record
        } catch (err) {
            throw err
        }
    }
}
module.exports = User</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Listing.html">Listing</a></li><li><a href="User.html">User</a></li></ul><h3>Global</h3><ul><li><a href="global.html">About Page</a></li><li><a href="global.html">Home Page</a></li><li><a href="global.html">Listing Page</a></li><li><a href="global.html">Login Page</a></li><li><a href="global.html">Login Script</a></li><li><a href="global.html">Logout Page</a></li><li><a href="global.html">Register Page</a></li><li><a href="global.html">Register Script</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Wed Nov 27 2019 23:26:52 GMT+0000 (Greenwich Mean Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
